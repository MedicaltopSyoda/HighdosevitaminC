<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>SATOIï½œãŒã‚“æƒ…å ±ï¼†ç›¸è«‡</title>
<style>
  /* ===== Theme (Lavender) ===== */
  :root{
    --primary:#7e57c2;       /* è–„ç´«ã®ä¸»è‰² */
    --primary-weak:#ede7f6;  /* è–„ã„èƒŒæ™¯ */
    --accent:#e91e63;        /* å·®ã—è‰²ï¼ˆãƒ­ãƒ¼ã‚ºãƒ”ãƒ³ã‚¯ï¼šæ—¢å­˜è¡¨ç¾ã‚‚ç¶™æ‰¿ï¼‰ */
    --bg:#f6f0ff;            /* å…¨ä½“èƒŒæ™¯ */
    --card:#ffffff;
    --text:#14131a;
    --muted:#6b6e76;
    --border:#e7e2f4;
    --radius:14px;
    --shadow:0 6px 18px rgba(71, 37, 133, .18);
    /* â–¼ ãƒ­ã‚´ï¼ˆå¾Œã§data URIã«å·®ã—æ›¿ãˆï¼‰ */
    --logo-small: url("VAR_LOGO_SMALL_DATA_URI");
    --logo-large: url("VAR_LOGO_LARGE_DATA_URI");
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#100f14; --card:#16141d; --text:#f5f6f9; --muted:#a7a9b3;
      --border:#2a2734; --primary-weak:#1e1a29; --shadow:0 10px 28px rgba(0,0,0,.55);
    }
  }

  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg, var(--bg), #fff 60%, var(--primary-weak));
    color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    overflow:hidden; display:flex; align-items:center; justify-content:center;
    padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom);
  }
  .view{display:none; position:absolute; inset:0; align-items:center; justify-content:center; flex-direction:column; text-align:center; transition:opacity .4s}
  .view.active{display:flex}
  .fade-out{opacity:0}

  /* ===== App Bar with SATOI ===== */
  .appbar{
    position:fixed; inset:env(safe-area-inset-top) 0 auto 0; height:56px; z-index:30;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:0 14px; background:rgba(255,255,255,.75); backdrop-filter:blur(10px) saturate(160%);
    border-bottom:1px solid var(--border);
  }
  @media (prefers-color-scheme: dark){ .appbar{ background:rgba(22,20,29,.7); } }
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px}
  .brand .logo{
    width:28px; height:28px; background-image:var(--logo-small);
    background-size:cover; background-position:center; border-radius:6px;
    box-shadow:0 2px 8px rgba(0,0,0,.12);
  }
  .brand .name{ font-size:16px; }
  .app-actions{display:flex; gap:6px}
  .chip{border:1px solid var(--border); color:var(--text); background:#fff0; border-radius:999px; padding:6px 10px; font-size:12px}

  /* ===== Splash (1stãƒ“ãƒ¥ãƒ¼ï¼šãƒ­ã‚´ï¼‹SATOIï¼‰ ===== */
  #view1{
    width:100%; height:100%;
    background:
      radial-gradient(800px 800px at 50% -20%, #ffffff 0%, var(--primary-weak) 70%, transparent 71%),
      linear-gradient(180deg, var(--bg), #fff 60%);
    display:flex; flex-direction:column; gap:12px; color:var(--accent);
  }
  .splash-logo{ width:82px; height:82px; background-image:var(--logo-large); background-size:cover; background-position:center; border-radius:12px; box-shadow:var(--shadow) }
  .splash-title{ font-size:22px; font-weight:800; letter-spacing:.15px }
  .splash-satoi{ font-size:13px; color:var(--muted); letter-spacing:2px }

  /* ===== Question Card (ä»¥å‰ã®ã‚¹ãƒ¯ã‚¤ãƒ—æŒ™å‹•ã¸æˆ»ã™) ===== */
  #card-container{ width:100%; height:100% }
  .card{
    position:absolute; width:min(86vw,380px); height:62vh; max-height:560px;
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    display:flex; flex-direction:column; justify-content:space-between; padding:18px;
    user-select:none; transition:transform .28s ease, opacity .28s ease; will-change:transform;
  }
  .card-question{ flex:1; display:flex; align-items:center; justify-content:center; font-size:21px; font-weight:700; line-height:1.35; padding:0 6px }

.card-options {
  display: flex;
  justify-content: space-between;
  font-size: 20px;
  margin-top: 20px;
  font-weight: bold;
  padding: 0 10px;
}
.left-option, .right-option {
  padding: 8px 16px;
  border-radius: 999px;
  border: 2px solid;
  background: #fff;
}
.left-option {
  border-color: var(--accent);
  color: var(--accent);
}
.right-option {
  border-color: var(--primary);
  color: var(--primary);
}

  /* è‰²ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆä»¥å‰ã®ã¾ã¾ï¼‰ */
  .card::before{ content:""; position:absolute; inset:0; border-radius:var(--radius); background:transparent; pointer-events:none; transition:background .12s }
  .card.swipe-left::before{ background:rgba(233,30,99,.12) }    /* ãƒ­ãƒ¼ã‚º */
  .card.swipe-right::before{ background:rgba(126,87,194,.12) } /* ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼ */

  /* ===== Final view wrapper ===== */
  .final-wrap{
    background:var(--card); padding:12px 12px 18px; width:min(96vw,640px); max-height:86vh;
    border-radius:var(--radius); box-shadow:var(--shadow); overflow:auto; text-align:left; position:relative;
  }
  /* ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¯çš„ãªãƒ­ã‚´ */
  .final-wrap::after{
    content:""; position:absolute; right:8px; bottom:8px; width:46px; height:46px; opacity:.16;
    background-image:var(--logo-small); background-size:cover; background-position:center; pointer-events:none;
  }
  .final-wrap h2{ margin:10px 0 12px; font-size:20px }

  /* ===== Grid Cardsï¼ˆæ‚£è€…/æ²»ç™‚/ã‚¨ãƒ“/ç”Ÿå­˜ç‡ å…±é€šï¼‰ ===== */
  .cards-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:10px }
  .x-card{
    background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px;
    box-shadow:0 2px 10px rgba(126,87,194,.08); display:flex; flex-direction:column; gap:6px;
  }
  .x-card h3{ margin:0; font-size:16px; line-height:1.3 }
  .x-meta{ font-size:12px; color:var(--muted); line-height:1.4 }
  .x-tag{ display:inline-block; font-size:11px; background:rgba(126,87,194,.08); border:1px solid rgba(126,87,194,.30); padding:2px 6px; border-radius:999px; margin-right:6px }
  .x-card button{ margin-top:6px; width:100%; padding:9px; font-size:14px; border:none; border-radius:10px; background:var(--primary); color:#fff }

  /* ===== Detail / CTA ===== */
  .detail-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; position:sticky; top:0; background:var(--card); padding-top:8px; z-index:1 }
  .back-link{ font-size:14px; color:var(--primary); text-decoration:underline; background:none; border:none }
  .detail-box{ background:rgba(126,87,194,.06); border:1px solid var(--border); border-radius:10px; padding:10px; margin:10px 0 }
  .cta{ width:100%; padding:12px; font-size:16px; background:var(--accent); color:#fff; border:none; border-radius:10px; margin-top:8px }

  /* ===== Filters ===== */
  .filters{ position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--border); border-radius:12px 12px 0 0; z-index:2; padding:8px }
  .filters .row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px }
  .filters .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:8px }
  .filters input,.filters select{ width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; font-size:14px; background:transparent; color:var(--text) }
  .filters .actions{ display:flex; gap:8px }
  .btn{ padding:10px; border:none; border-radius:10px; font-size:14px }
  .btn-primary{ background:var(--primary); color:#fff } .btn-ghost{ background:transparent; border:1px solid var(--border); color:var(--text) }
  .count{ font-size:12px; color:var(--muted); margin:4px 0 0 2px }

  /* ===== AI Chat (LINEé¢¨) with SATOI ===== */
  #chat-modal{ position:fixed; inset:0; z-index:1000; background:var(--bg); display:none; flex-direction:column }
  .chat-header{ background:var(--primary); color:#fff; padding:12px; font-size:18px; display:flex; justify-content:space-between; align-items:center; padding-top:calc(12px + env(safe-area-inset-top)) }
  .chat-header .brand{ gap:8px }
  .chat-header .logo{ width:22px; height:22px; background-image:var(--logo-small); background-size:cover; border-radius:5px }
  .chat-close{ background:transparent; border:1px solid rgba(255,255,255,.7); color:#fff; border-radius:999px; padding:6px 10px; font-size:14px }
  .chat-messages{ flex:1; overflow-y:auto; padding:12px; background:linear-gradient(180deg, rgba(126,87,194,.06), rgba(126,87,194,.12)); display:flex; flex-direction:column; gap:8px }
  .chat-bubble{ max-width:74%; padding:9px 12px; border-radius:16px; line-height:1.45; box-shadow:0 1px 3px rgba(0,0,0,.06) }
  .chat-ai{ background:#e0e0e0; color:#111; align-self:flex-start; border-bottom-left-radius:0 }
  .chat-user{ background:var(--primary); color:#fff; align-self:flex-end; border-bottom-right-radius:0 }
  .chat-input{ display:flex; gap:8px; padding:10px; padding-bottom:calc(10px + env(safe-area-inset-bottom)); background:var(--card); border-top:1px solid var(--border) }
  .chat-input input{ flex:1; padding:11px 12px; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--text) }
  .chat-input button{ padding:11px 14px; border:none; border-radius:999px; background:var(--primary); color:#fff }

/* â–¼â–¼ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼ */
.tutorial {
  position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 100;
  display: flex; justify-content: center; align-items: center; color: #fff;
}
.tutorial-content {
  background: rgba(255,255,255,.1); padding: 20px; border-radius: 12px;
  border: 1px solid rgba(255,255,255,.3); text-align: center;
}
.tutorial-icon {
  font-size: 48px; animation: swipeAnim 1s infinite alternate;
}
@keyframes swipeAnim {
  from { transform: translateX(-10px); }
  to   { transform: translateX(10px); }
}
.start-btn {
  margin-top: 12px; padding: 10px 16px; border: none;
  border-radius: 999px; background: var(--primary); color: #fff;
  font-size: 14px;
}
/* â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–² */

</style>
</head>
<body>

<!-- App Bar -->
<div class="appbar">
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div class="name">SATOI</div>
  </div>
  <div class="app-actions">
    <button class="chip" onclick="document.getElementById('about').style.display='block'">ï¼Ÿ ã“ã®ã‚¢ãƒ—ãƒª</button>
  </div>
</div>
<div id="tutorial-overlay" class="tutorial">
  <div class="tutorial-content">
    <div class="tutorial-icon">ğŸ‘‰</div>
    <p><strong>å³ã«ã‚¹ãƒ¯ã‚¤ãƒ—</strong>ã§ã€Œã¯ã„ã€<br><strong>å·¦ã«ã‚¹ãƒ¯ã‚¤ãƒ—</strong>ã§ã€Œã„ã„ãˆã€</p>
    <button class="start-btn" onclick="startTutorial()">ã‚¿ãƒƒãƒ—ã—ã¦å§‹ã‚ã‚‹</button>
  </div>
</div>
<!-- About sheet -->
<div id="about" style="display:none; position:fixed; inset:0; z-index:40; background:rgba(0,0,0,.4)" onclick="if(event.target.id==='about'){this.style.display='none'}">
  <div style="width:min(92vw,560px); margin:12vh auto; background:var(--card); color:var(--text); border-radius:14px; box-shadow:var(--shadow); padding:14px">
    <h3 style="margin:6px 0 8px;">SATOIã«ã¤ã„ã¦</h3>
    <p style="margin:0; color:var(--muted); font-size:14px;">è–„ç´«ã‚’åŸºèª¿ã«ã€ã‚¹ãƒ¯ã‚¤ãƒ—ã§åˆ†å²ã—ãªãŒã‚‰ã€Œæ‚£è€…ãƒ»æ²»ç™‚ãƒ»ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãƒ»ç”Ÿå­˜ç‡ãƒ»ç›¸è«‡ã€ã«ç´ æ—©ãåˆ°é”ã§ãã¾ã™ã€‚<br>å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼å³ã®é¸æŠè‚¢ã€å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼å·¦ã®é¸æŠè‚¢ã§ã™ã€‚</p>
    <button class="btn btn-primary" style="margin-top:12px" onclick="document.getElementById('about').style.display='none'">OK</button>
  </div>
</div>

<!-- 1stãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ï¼šãƒ­ã‚´ï¼‹SATOIï¼‰ -->
<div class="view active" id="view1">
  <div class="splash-logo" aria-hidden="true"></div>
  <div class="splash-title">ãŒã‚“ã®æƒ…å ±ã®ã™ã¹ã¦ãŒã“ã“ã«ã‚ã‚‹</div>
  <div class="splash-satoi">SATOI</div>
</div>

<!-- Tinderã‚«ãƒ¼ãƒ‰ï¼ˆè³ªå•ï¼‰ -->
<div class="view" id="card-container"></div>

<!-- æœ€çµ‚ãƒ“ãƒ¥ãƒ¼ï¼ˆä¸€è¦§ãƒ»è©³ç´°ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ç­‰ï¼‰ -->
<div class="view" id="final-view">
  <div class="final-wrap" id="final-content"></div>
</div>

<!-- LINEé¢¨AIãƒãƒ£ãƒƒãƒˆï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã«SATOIï¼‰ -->
<div id="chat-modal">
  <div class="chat-header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="name">SATOI AIç›¸è«‡</div>
    </div>
    <button class="chat-close" onclick="closeChat()">Ã—é–‰ã˜ã‚‹</button>
  </div>
  <div class="chat-messages" id="chat-area">
    <div class="chat-bubble chat-ai">ã“ã‚“ã«ã¡ã¯ã€AIãŒã‚“ç›¸è«‡ã§ã™ã€‚ã©ã‚“ãªã“ã¨ã§ã‚‚ãŠèããã ã•ã„ã€‚</div>
  </div>
  <form class="chat-input" onsubmit="event.preventDefault();sendMessage();">
    <input type="text" id="chat-input" placeholder="è³ªå•ã‚’å…¥åŠ›â€¦" required>
    <button type="submit">é€ä¿¡</button>
  </form>
</div>

<script>
/* ===== åˆ†å²ï¼ˆæ‚£è€…ãƒ«ãƒ¼ãƒˆã®è¿½åŠ è¨­å•ï¼†ç›¸è«‡åˆ†å²ã¯æ®ãˆç½®ãï¼‰ ===== */
const flow = {
  start:{ q:"ã‚ãªãŸã¯ãŒã‚“æ‚£è€…ã§ã™ã‹ï¼Ÿ", left:"ã„ã„ãˆ", right:"ã¯ã„", next:{ left:"notpatient", right:"patientChoice" } },
  patientChoice:{ q:"ã©ã†ã—ã¾ã™ã‹ï¼Ÿ", left:"æƒ…å ±ã‚’é–²è¦§ã—ãŸã„", right:"ã™ãç›¸è«‡ã—ãŸã„", next:{ left:"patientInfo", right:"consultChoice" } },
  patientInfo:{ q:"ã©ã¡ã‚‰ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿ", left:"åŒã˜æ‚£è€…", right:"ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹", next:{ left:"patientlist", right:"evidence" } },
  consultChoice:{ q:"ã”å¸Œæœ›ã¯ã©ã¡ã‚‰ã§ã™ã‹ï¼Ÿ", left:"ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥é€šè©±", right:"AIç›¸è«‡", next:{ left:"concierge", right:"ai" } },
  notpatient:{ q:"ã‚ãªãŸã¯ï¼Ÿ", left:"ãã‚Œä»¥å¤–", right:"å®¶æ—", next:{ left:"other", right:"family" } },
  family:{ q:"ä½•ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿ", left:"ç”Ÿå­˜ç‡", right:"æ²»ç™‚æ³•", next:{ left:"survival", right:"treatment" } },
  other:{ q:"ã‚ãªãŸã¯ï¼Ÿ", left:"ãã‚Œä»¥å¤–", right:"ç ”ç©¶è€…", next:{ left:"contact", right:"contact" } }
};

/* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
const patients = [
  { id:1,sex:"ç”·æ€§",age:55,cancer:"è‚ºãŒã‚“",stage:"Stage IIIA",years:2.0,city:"æ±äº¬",  summary:"æ‰‹è¡“ï¼‹åŒ–å­¦æ”¾å°„ç·šç™‚æ³•å¾Œã€åˆ†å­æ¨™çš„è–¬ã‚’ç¶™ç¶šä¸­ã€‚å‰¯ä½œç”¨ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã«é–¢å¿ƒã€‚", contact:"patient1@example.com" },
  { id:2,sex:"å¥³æ€§",age:42,cancer:"ä¹³ãŒã‚“",stage:"Stage IIB", years:1.5,city:"æ¨ªæµœ",  summary:"è¡“å‰åŒ–å­¦ç™‚æ³•â†’ä¹³æˆ¿æ¸©å­˜â†’æ”¾å°„ç·šã€‚ä»•äº‹ã¨æ²»ç™‚ã®ä¸¡ç«‹ã®æƒ…å ±äº¤æ›ã‚’å¸Œæœ›ã€‚", contact:"patient2@example.com" },
  { id:3,sex:"ç”·æ€§",age:68,cancer:"å‰ç«‹è…ºãŒã‚“",stage:"Stage IV", years:3.0,city:"åå¤å±‹",summary:"ãƒ›ãƒ«ãƒ¢ãƒ³ç™‚æ³•ã¨æ”¾å°„ç·šã‚’ä½µç”¨ã€‚é‹å‹•ãƒ»æ „é¤Šã®å·¥å¤«ã‚‚å…±æœ‰å¯èƒ½ã€‚", contact:"patient3@example.com" },
  { id:4,sex:"å¥³æ€§",age:50,cancer:"å¤§è…¸ãŒã‚“",stage:"Stage III", years:2.5,city:"å¤§é˜ª",  summary:"è…¹è…”é¡æ‰‹è¡“å¾Œã®è£œåŠ©åŒ–å­¦ç™‚æ³•ã€‚å†ç™ºä¸å®‰ã¨ã®å‘ãåˆã„æ–¹ã«é–¢å¿ƒã€‚", contact:"patient4@example.com" },
  { id:5,sex:"ç”·æ€§",age:60,cancer:"èƒƒãŒã‚“",stage:"Stage II", years:1.2,city:"æœ­å¹Œ",  summary:"å¹½é–€å´èƒƒåˆ‡é™¤å¾Œã®è£œåŠ©ç™‚æ³•ã€‚é£Ÿäº‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®çµŒé¨“å…±æœ‰ã€‚", contact:"patient5@example.com" },
  { id:6,sex:"å¥³æ€§",age:35,cancer:"åµå·£ãŒã‚“",stage:"Stage III", years:2.8,city:"ç¦å²¡",  summary:"è¡“å¾ŒåŒ–å­¦ç™‚æ³•ã€‚å¦Šå­•æ€§ã¨æ²»ç™‚ã®ä¸¡ç«‹ã®æƒ…å ±ãŒæ¬²ã—ã„æ–¹ã¸ã€‚", contact:"patient6@example.com" }
];

const treatments = [
  { id:101, name:"æ‰‹è¡“ç™‚æ³•", type:"å¤–ç§‘", indication:"å±€æ‰€åˆ¶å¾¡ãŒå¯èƒ½ãªå›ºå½¢è…«ç˜", level:"æ¨å¥¨åº¦Aï¼ˆä¾‹ï¼‰",
    summary:"è…«ç˜ã‚’å¤–ç§‘çš„ã«åˆ‡é™¤ã€‚æ—©æœŸãŒã‚“ã§ã¯æ ¹æ²»ã‚’ç›®æŒ‡ã™ä¸»è¦é¸æŠè‚¢ã€‚", risks:"å‡ºè¡€ãƒ»æ„ŸæŸ“ãƒ»è¡“å¾Œåˆä½µç—‡", cost:"ç›®å®‰: 30-150ä¸‡å††", duration:"1æ—¥ã€œæ•°é€±é–“ï¼ˆå…¥é™¢å«ã‚€ï¼‰", tags:["æ ¹æ²»ç›®çš„","å±€æ‰€æ²»ç™‚"] },
  { id:102, name:"åŒ–å­¦ç™‚æ³•", type:"è–¬ç‰©", indication:"é€²è¡Œãƒ»å†ç™ºä¾‹ã€è£œåŠ©ç™‚æ³•", level:"æ¨å¥¨åº¦Aã€œBï¼ˆä¾‹ï¼‰",
    summary:"æŠ—ãŒã‚“å‰¤ã«ã‚ˆã‚‹å…¨èº«æ²»ç™‚ã€‚ãƒ¬ã‚¸ãƒ¡ãƒ³ã«ã‚ˆã‚ŠåŠ¹æœãƒ»å‰¯ä½œç”¨ãŒç•°ãªã‚‹ã€‚", risks:"éª¨é«„æŠ‘åˆ¶ãƒ»æ‚ªå¿ƒå˜”åãƒ»è„±æ¯›ãªã©", cost:"æœˆ10-50ä¸‡å††ç›®å®‰", duration:"3ã€œ6ãƒ¶æœˆ", tags:["å…¨èº«æ²»ç™‚","æ¨™æº–æ²»ç™‚"] },
  { id:103, name:"æ”¾å°„ç·šç™‚æ³•", type:"å±€æ‰€", indication:"å±€æ‰€åˆ¶å¾¡ãƒ»è¡“å‰/è¡“å¾Œè£œåŠ©", level:"æ¨å¥¨åº¦Aï¼ˆä¾‹ï¼‰",
    summary:"é«˜ã‚¨ãƒãƒ«ã‚®ãƒ¼ç·šã§è…«ç˜ç´°èƒã‚’ç ´å£Šã€‚å®šä½ç…§å°„ã‚„å¼·åº¦å¤‰èª¿ãªã©ã€‚", risks:"çš®è†šç‚ãƒ»ç²˜è†œç‚ã»ã‹è‡“å™¨ç‰¹ç•°å‰¯ä½œç”¨", cost:"ç·é¡30-100ä¸‡å††", duration:"1ã€œ6é€±é–“", tags:["å±€æ‰€æ²»ç™‚","å¤–æ¥å¯"] },
  { id:104, name:"å…ç–«ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆé˜»å®³è–¬", type:"è–¬ç‰©", indication:"ãƒã‚¤ã‚ªãƒãƒ¼ã‚«ãƒ¼é™½æ€§ä¾‹", level:"æ¨å¥¨åº¦Aã€œBï¼ˆä¾‹ï¼‰",
    summary:"å…ç–«åå¿œã‚’æ´»æ€§åŒ–ã€‚é•·æœŸå¥åŠ¹ä¾‹ã‚‚ã€‚", risks:"å…ç–«é–¢é€£æœ‰å®³äº‹è±¡ï¼ˆè‚ç‚ãƒ»è‚ºç‚ç­‰ï¼‰", cost:"æœˆ30-150ä¸‡å††ç›®å®‰", duration:"é•·æœŸç¶™ç¶šå¯", tags:["å…¨èº«æ²»ç™‚","ãƒã‚¤ã‚ªãƒãƒ¼ã‚«ãƒ¼"] },
  { id:105, name:"åˆ†å­æ¨™çš„æ²»ç™‚", type:"è–¬ç‰©", indication:"ç‰¹å®šéºä¼å­å¤‰ç•°é™½æ€§", level:"æ¨å¥¨åº¦Aï¼ˆä¾‹ï¼‰",
    summary:"åˆ†å­ç•°å¸¸ã‚’æ¨™çš„åŒ–ã€‚é«˜ã„å¥åŠ¹ãŒæœŸå¾…ã€‚", risks:"çš®ç–¹ãƒ»ä¸‹ç—¢ãƒ»è‚æ©Ÿèƒ½éšœå®³ãªã©", cost:"æœˆ20-120ä¸‡å††ç›®å®‰", duration:"é•·æœŸç¶™ç¶šå¯", tags:["å…¨èº«æ²»ç™‚","ç²¾å¯†åŒ»ç™‚"] }
];

const evidences = [
  { id:201, title:"IIIæœŸå¤§è…¸ãŒã‚“ã®è¡“å¾Œè£œåŠ©åŒ–å­¦ç™‚æ³•", type:"RCT/å¤šæ–½è¨­", cancer:"å¤§è…¸ãŒã‚“", year:2023, outcome:"DFSæ”¹å–„ HR=0.78", level:"ãƒ¬ãƒ™ãƒ«A",
    summary:"æ‰‹è¡“å¾Œè£œåŠ©åŒ–å­¦ç™‚æ³•ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã€‚å†ç™ºæŠ‘åˆ¶åŠ¹æœã‚’ç¤ºå”†ã€‚é«˜é½¢å±¤ã§ã‚‚æœ‰åŠ¹ã€‚", link:"#(DOIç­‰)" },
  { id:202, title:"å…ç–«CPé˜»å®³è–¬ã®é•·æœŸæˆç¸¾ï¼ˆPD-L1é™½æ€§ï¼‰", type:"ãƒ¡ã‚¿è§£æ", cancer:"NSCLC", year:2024, outcome:"OSå»¶é•· HR=0.72", level:"ãƒ¬ãƒ™ãƒ«A",
    summary:"PD-L1é«˜ç™ºç¾ä¾‹ã§å…ç–«ç™‚æ³•ãŒåŒ–å­¦ç™‚æ³•ã‚’ä¸Šå›ã‚‹é•·æœŸç”Ÿå­˜ã€‚", link:"#(DOIç­‰)" },
  { id:203, title:"è¡“å‰åŒ–å­¦ç™‚æ³• vs ç›´æ‰‹è¡“ï¼ˆHER2é™°æ€§ä¹³ãŒã‚“ï¼‰", type:"RCT", cancer:"ä¹³ãŒã‚“", year:2022, outcome:"pCRå‘ä¸Š OR=1.9", level:"ãƒ¬ãƒ™ãƒ«B",
    summary:"è¡“å‰åŒ–å­¦ç™‚æ³•ã§pCRç‡ãŒæœ‰æ„ã«ä¸Šæ˜‡ã€‚æ¸©å­˜ç‡ã‚‚æ”¹å–„ã€‚", link:"#(DOIç­‰)" }
];

const survivals = [
  { id:301, cancer:"è‚ºãŒã‚“", stage:"å…¨ä½“", one:55, three:38, five:30, source:"å›½å†…ãŒã‚“ç™»éŒ²ï¼ˆä¾‹ï¼‰2020" },
  { id:302, cancer:"ä¹³ãŒã‚“", stage:"å…¨ä½“", one:95, three:92, five:90, source:"å›½å†…ãŒã‚“ç™»éŒ²ï¼ˆä¾‹ï¼‰2020" },
  { id:303, cancer:"å¤§è…¸ãŒã‚“", stage:"å…¨ä½“", one:90, three:80, five:70, source:"å›½å†…ãŒã‚“ç™»éŒ²ï¼ˆä¾‹ï¼‰2020" }
];

/* ===== Core UI ===== */
let currentNode="start";
const container=document.getElementById("card-container");
const finalView=document.getElementById("final-view");
const finalContent=document.getElementById("final-content");

/* ä»¥å‰ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ãƒ¯ã‚¤ãƒ—æŒ™å‹• */
function createCard(nodeKey){
  const data=flow[nodeKey];
  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
    <div class="card-question">${data.q}</div>
    <div class="card-options">
      <div class="left-option">â† ${data.left}</div>
      <div class="right-option">${data.right} â†’</div>
    </div>`;
  container.appendChild(card);

  let startX=0,dx=0,drag=false;
  card.addEventListener("touchstart",e=>{startX=e.touches[0].clientX;drag=true;});
  card.addEventListener("touchmove",e=>{
    if(!drag) return;
    dx=e.touches[0].clientX-startX;
    card.style.transform=`translateX(${dx}px) rotate(${dx*0.05}deg)`;
    card.classList.toggle("swipe-right",dx>30);
    card.classList.toggle("swipe-left",dx<-30);
  });
  card.addEventListener("touchend",()=>{
    drag=false; card.classList.remove("swipe-left","swipe-right");
    if(Math.abs(dx)>100){
      const dir=dx>0?"right":"left";
      const next=data.next[dir];
      card.style.transform=`translateX(${dx>0?520:-520}px) rotate(${dx*0.1}deg)`;
      card.style.opacity=0;
      setTimeout(()=>{container.removeChild(card); handleNext(next);},260);
    }else{
      card.style.transform="translateX(0) rotate(0)";
    }
    dx=0;
  });
}

function handleNext(nodeKey){
  if(nodeKey==="ai"){ showAIConsult(); return; }
  if(nodeKey==="concierge"){ showConciergeForm(); return; }
  if(nodeKey==="patientlist"){ showPatientsList(); return; }
  if(nodeKey==="treatment"){ showTreatmentsList(); return; }
  if(nodeKey==="evidence"){ showEvidenceList(); return; }
  if(nodeKey==="survival"){ showSurvivalList(); return; }
  if(nodeKey==="contact"){ showFinal(contactHTML); return; }
  createCard(nodeKey);
}

function showFinal(html){
  container.classList.remove("active");
  finalView.classList.add("active");
  finalContent.innerHTML=html;
}

/* ===== Concierge Form ===== */
const contactHTML = `<h2>ãŠå•ã„åˆã‚ã›</h2>
  <p style="color:var(--muted);">ã”ç”¨ä»¶ã‚’ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚æ‹…å½“ã‚ˆã‚Šã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚</p>
  <form onsubmit="event.preventDefault(); alert('é€ä¿¡ã—ã¾ã—ãŸ');">
    <input type="text" placeholder="ãŠåå‰" required>
    <input type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
    <textarea rows="4" placeholder="ãŠå•ã„åˆã‚ã›å†…å®¹" required></textarea>
    <button class="cta" type="submit">é€ä¿¡</button>
  </form>`;

function showConciergeForm(){
  showFinal(`
    <h2>ãŒã‚“ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥é€šè©±ã‚’äºˆç´„</h2>
    <p style="color:var(--muted);">å¸Œæœ›æ—¥æ™‚ã¨ã”é€£çµ¡å…ˆã‚’ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚å°‚é–€ã‚¹ã‚¿ãƒƒãƒ•ãŒæŠ˜ã‚Šè¿”ã—ã¾ã™ã€‚</p>
    <form onsubmit="event.preventDefault(); alert('é€ä¿¡ã—ã¾ã—ãŸã€‚æ‹…å½“ã‚ˆã‚Šã”é€£çµ¡ã—ã¾ã™ã€‚');">
      <input type="text" placeholder="ãŠåå‰" required>
      <input type="tel" placeholder="é›»è©±ç•ªå·ï¼ˆãƒã‚¤ãƒ•ãƒ³å¯ï¼‰" required>
      <input type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
      <input type="datetime-local" required>
      <textarea rows="4" placeholder="ã”ç›¸è«‡å†…å®¹ï¼ˆä»»æ„ï¼‰"></textarea>
      <button class="cta" type="submit">äºˆç´„ã‚’é€ä¿¡</button>
    </form>
  `);
}

/* ===== AIç›¸è«‡ï¼ˆæ¡ˆå†…â†’LINEé¢¨ãƒãƒ£ãƒƒãƒˆï¼‰ ===== */
function showAIConsult(){
  showFinal(`
    <h2>SATOI AIã«ç›¸è«‡</h2>
    <p style="color:var(--muted);">AIãŒ24æ™‚é–“ã”ç›¸è«‡ã«å¯¾å¿œã—ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>
    <button class="cta" onclick="openChat()">AIãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã™ã‚‹ï¼ˆãƒ‡ãƒ¢ï¼‰</button>
  `);
}
function openChat(){ document.getElementById("chat-modal").style.display="flex"; }
function closeChat(){
  document.getElementById("chat-modal").style.display="none";
  document.getElementById("chat-area").innerHTML =
    '<div class="chat-bubble chat-ai">ã“ã‚“ã«ã¡ã¯ã€AIãŒã‚“ç›¸è«‡ã§ã™ã€‚ã©ã‚“ãªã“ã¨ã§ã‚‚ãŠèããã ã•ã„ã€‚</div>';
}
function sendMessage(){
  const input=document.getElementById("chat-input"); const text=input.value.trim(); if(!text) return;
  const area=document.getElementById("chat-area");
  const userMsg=document.createElement("div"); userMsg.className="chat-bubble chat-user"; userMsg.textContent=text;
  area.appendChild(userMsg); area.scrollTop=area.scrollHeight; input.value="";
  setTimeout(()=>{
    const aiMsg=document.createElement("div"); aiMsg.className="chat-bubble chat-ai";
    aiMsg.textContent="AIã®ãƒ€ãƒŸãƒ¼å›ç­”ã§ã™ã€‚æ¨™æº–æ²»ç™‚ãƒ»å‰¯ä½œç”¨ãªã©ä¸€èˆ¬æƒ…å ±ã‚’ãŠä¼ãˆã—ã¾ã™ã€‚";
    area.appendChild(aiMsg); area.scrollTop=area.scrollHeight;
  }, 900);
}

/* ===== æ‚£è€…ãƒªã‚¹ãƒˆï¼ˆæ¤œç´¢ãƒ»è©³ç´°ï¼‰ ===== */
let currentFilters = { sex:"", cancer:"", stage:"", city:"", ageMin:"", ageMax:"", yearsMin:"", yearsMax:"", keyword:"" };
function uniq(list,key){ return [...new Set(list.map(x=>x[key]))]; }
function buildFilters(){
  const sexOpts=["",...uniq(patients,"sex")], cancerOpts=["",...uniq(patients,"cancer")], stageOpts=["",...uniq(patients,"stage")], cityOpts=["",...uniq(patients,"city")];
  return `
    <div class="filters">
      <div class="row">
        <select id="f-sex">${sexOpts.map(v=>`<option value="${v}">${v||"æ€§åˆ¥"}</option>`).join("")}</select>
        <select id="f-cancer">${cancerOpts.map(v=>`<option value="${v}">${v||"ãŒã‚“ç¨®"}</option>`).join("")}</select>
      </div>
      <div class="row">
        <select id="f-stage">${stageOpts.map(v=>`<option value="${v}">${v||"ã‚¹ãƒ†ãƒ¼ã‚¸"}</option>`).join("")}</select>
        <select id="f-city">${cityOpts.map(v=>`<option value="${v}">${v||"åœ°åŸŸ"}</option>`).join("")}</select>
      </div>
      <div class="row3">
        <input id="f-ageMin" type="number" inputmode="numeric" placeholder="å¹´é½¢Min">
        <input id="f-ageMax" type="number" inputmode="numeric" placeholder="å¹´é½¢Max">
        <input id="f-yearsMin" type="number" inputmode="decimal" step="0.1" placeholder="æ²»ç™‚å¹´æ•°Min">
      </div>
      <div class="row3">
        <input id="f-yearsMax" type="number" inputmode="decimal" step="0.1" placeholder="æ²»ç™‚å¹´æ•°Max">
        <input id="f-keyword" type="search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆè¦ç´„ãƒ»åœ°åŸŸ ç­‰ï¼‰">
        <div class="actions">
          <button id="btn-apply" class="btn btn-primary" style="flex:1">é©ç”¨</button>
          <button id="btn-reset" class="btn btn-ghost" style="flex:1">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div class="count" id="result-count"></div>
    </div>`;
}
function applyFilters(list){
  const f=currentFilters;
  return list.filter(p=>{
    if(f.sex && p.sex!==f.sex) return false;
    if(f.cancer && p.cancer!==f.cancer) return false;
    if(f.stage && p.stage!==f.stage) return false;
    if(f.city && p.city!==f.city) return false;
    if(f.ageMin!=="" && p.age < Number(f.ageMin)) return false;
    if(f.ageMax!=="" && p.age > Number(f.ageMax)) return false;
    if(f.yearsMin!=="" && p.years < Number(f.yearsMin)) return false;
    if(f.yearsMax!=="" && p.years > Number(f.yearsMax)) return false;
    if(f.keyword){
      const kw=f.keyword.trim().toLowerCase();
      const hay=[p.summary,p.city,p.cancer,p.stage,`${p.sex}`,`${p.age}`,`${p.years}`].join(" ").toLowerCase();
      if(!hay.includes(kw)) return false;
    }
    return true;
  });
}
function renderPatients(list){
  return `<div class="cards-grid">${
    list.map(p=>`
      <div class="x-card" onclick="showPatientDetail(${p.id})" role="button" tabindex="0" aria-label="æ‚£è€…è©³ç´°: ${p.sex} ${p.age}æ­³ ${p.cancer}">
        <h3>${p.sex}ãƒ»${p.age}æ­³</h3>
        <div class="x-meta">${p.cancer}ï¼${p.stage}</div>
        <div class="x-meta">æ²»ç™‚å¹´æ•°ï¼š${p.years}å¹´</div>
        <div><span class="x-tag">${p.city}</span><span class="x-tag">${p.cancer}</span></div>
        <button type="button">è©³ç´°ã‚’è¦‹ã‚‹</button>
      </div>`).join("")
  }</div>`;
}
function attachFilterEvents(){
  const get=id=>document.getElementById(id);
  const ids=["f-sex","f-cancer","f-stage","f-city","f-ageMin","f-ageMax","f-yearsMin","f-yearsMax","f-keyword"];
  ids.forEach(id=>{ const el=get(id); el.value=currentFilters[id.replace("f-","")] ?? ""; });
  function readFilters(){
    currentFilters={
      sex:get("f-sex").value, cancer:get("f-cancer").value, stage:get("f-stage").value, city:get("f-city").value,
      ageMin:get("f-ageMin").value, ageMax:get("f-ageMax").value, yearsMin:get("f-yearsMin").value, yearsMax:get("f-yearsMax").value,
      keyword:get("f-keyword").value
    };
  }
  function update(){
    readFilters(); const result=applyFilters(patients);
    get("result-count").textContent=`è©²å½“ ${result.length} ä»¶`;
    get("list-area").innerHTML=renderPatients(result);
  }
  get("btn-apply").addEventListener("click",update);
  get("btn-reset").addEventListener("click",()=>{ currentFilters={sex:"",cancer:"",stage:"",city:"",ageMin:"",ageMax:"",yearsMin:"",yearsMax:"",keyword:""}; update(); });
  ["f-sex","f-cancer","f-stage","f-city"].forEach(id=>document.getElementById(id).addEventListener("change",update));
}
function showPatientsList(){
  container.classList.remove("active"); finalView.classList.add("active");
  finalContent.innerHTML = `
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
      <div style="width:18px;height:18px;background-image:var(--logo-small);background-size:cover;border-radius:4px"></div>
      <strong>SATOI æ‚£è€…ãƒªã‚¹ãƒˆ</strong>
    </div>
    ${buildFilters()}
    <div id="list-area">${renderPatients(applyFilters(patients))}</div>`;
  document.getElementById("result-count").textContent=`è©²å½“ ${applyFilters(patients).length} ä»¶`;
  attachFilterEvents();
}
window.showPatientDetail = function(id){
  const p=patients.find(x=>x.id===id); if(!p) return;
  finalContent.innerHTML = `
    <div class="detail-head">
      <h2>æ‚£è€…è©³ç´°</h2>
      <button class="back-link" onclick="showPatientsList()">â† ä¸€è¦§ã¸æˆ»ã‚‹</button>
    </div>
    <div class="detail-box">
      <div><strong>æ€§åˆ¥ãƒ»å¹´é½¢ï¼š</strong>${p.sex}ãƒ»${p.age}æ­³</div>
      <div><strong>ãŒã‚“ç¨®ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¸ï¼š</strong>${p.cancer}ï¼${p.stage}</div>
      <div><strong>æ²»ç™‚å¹´æ•°ï¼š</strong>${p.years}å¹´</div>
      <div><strong>åœ°åŸŸï¼š</strong>${p.city}</div>
    </div>
    <p>${p.summary}</p>
    <button class="cta" onclick="openContact('${p.contact}')">é€£çµ¡ã™ã‚‹</button>
  `;
};
window.openContact=function(email){
  finalContent.innerHTML += `
    <div class="detail-box">
      <h3 style="margin:0 0 8px;">é€£çµ¡ãƒ•ã‚©ãƒ¼ãƒ </h3>
      <form onsubmit="event.preventDefault(); alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ'); showPatientsList();">
        <input type="text" placeholder="ãŠåå‰" required>
        <input type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
        <textarea rows="4" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ${email} å®›ï¼‰" required></textarea>
        <button class="cta" type="submit">é€ä¿¡</button>
      </form>
    </div>`;
};

/* ===== æ²»ç™‚æ³• ===== */
function renderTreatments(list){
  return `<div class="cards-grid">${
    list.map(t=>`
      <div class="x-card" onclick="showTreatmentDetail(${t.id})" role="button" tabindex="0">
        <h3>${t.name}</h3>
        <div class="x-meta">${t.type}ï¼é©å¿œï¼š${t.indication}</div>
        <div class="x-meta">æ¨å¥¨åº¦ï¼š${t.level}</div>
        <div>${t.tags.map(x=>`<span class="x-tag">${x}</span>`).join("")}</div>
        <button type="button">è©³ç´°ã‚’è¦‹ã‚‹</button>
      </div>`).join("")
  }</div>`;
}
function showTreatmentsList(){
  container.classList.remove("active"); finalView.classList.add("active");
  finalContent.innerHTML = `
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
      <div style="width:18px;height:18px;background-image:var(--logo-small);background-size:cover;border-radius:4px"></div>
      <strong>SATOI æ²»ç™‚æ³•ãƒªã‚¹ãƒˆ</strong>
    </div>
    ${renderTreatments(treatments)}`;
}
window.showTreatmentDetail = function(id){
  const t=treatments.find(x=>x.id===id); if(!t) return;
  finalContent.innerHTML = `
    <div class="detail-head">
      <h2>æ²»ç™‚æ³•è©³ç´°</h2>
      <button class="back-link" onclick="showTreatmentsList()">â† ä¸€è¦§ã¸æˆ»ã‚‹</button>
    </div>
    <div class="detail-box">
      <div><strong>æ²»ç™‚åï¼š</strong>${t.name}</div>
      <div><strong>åˆ†é¡ï¼š</strong>${t.type}</div>
      <div><strong>é©å¿œï¼š</strong>${t.indication}</div>
      <div><strong>æ¨å¥¨åº¦ãƒ»ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ï¼š</strong>${t.level}</div>
    </div>
    <p>${t.summary}</p>
    <div class="detail-box">
      <div><strong>ä¸»ãªãƒªã‚¹ã‚¯ãƒ»å‰¯ä½œç”¨ï¼š</strong>${t.risks}</div>
      <div><strong>æ²»ç™‚æœŸé–“ï¼š</strong>${t.duration}</div>
      <div><strong>è²»ç”¨ç›®å®‰ï¼š</strong>${t.cost}</div>
    </div>
    <button class="cta" onclick="openFacilityContact('${t.name}')">åŒ»ç™‚æ©Ÿé–¢ã«å•ã„åˆã‚ã›</button>
  `;
};
window.openFacilityContact=function(tName){
  finalContent.innerHTML += `
    <div class="detail-box">
      <h3 style="margin:0 0 8px;">æ²»ç™‚æ³•ã«é–¢ã™ã‚‹ãŠå•ã„åˆã‚ã›</h3>
      <form onsubmit="event.preventDefault(); alert('ãŠå•ã„åˆã‚ã›ã‚’é€ä¿¡ã—ã¾ã—ãŸ'); showTreatmentsList();">
        <input type="text" placeholder="ãŠåå‰" required>
        <input type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
        <textarea rows="4" placeholder="ã€${tName}ã€ã«ã¤ã„ã¦è³ªå•ãƒ»ç›¸è«‡äº‹é …" required></textarea>
        <button class="cta" type="submit">é€ä¿¡</button>
      </form>
    </div>`;
};

/* ===== ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ ===== */
function renderEvidences(list){
  return `<div class="cards-grid">${
    list.map(e=>`
      <div class="x-card" onclick="showEvidenceDetail(${e.id})" role="button" tabindex="0">
        <h3>${e.title}</h3>
        <div class="x-meta">${e.type}ï¼${e.cancer}ï¼${e.year}å¹´</div>
        <div class="x-meta">ä¸»è¦æ‰€è¦‹ï¼š${e.outcome}</div>
        <div><span class="x-tag">${e.level}</span><span class="x-tag">${e.cancer}</span></div>
        <button type="button">è©³ç´°ã‚’è¦‹ã‚‹</button>
      </div>`).join("")
  }</div>`;
}
function showEvidenceList(){
  container.classList.remove("active"); finalView.classList.add("active");
  finalContent.innerHTML = `
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
      <div style="width:18px;height:18px;background-image:var(--logo-small);background-size:cover;border-radius:4px"></div>
      <strong>SATOI ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹</strong>
    </div>
    ${renderEvidences(evidences)}`;
}
window.showEvidenceDetail = function(id){
  const e=evidences.find(x=>x.id===id); if(!e) return;
  finalContent.innerHTML = `
    <div class="detail-head">
      <h2>ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹è©³ç´°</h2>
      <button class="back-link" onclick="showEvidenceList()">â† ä¸€è¦§ã¸æˆ»ã‚‹</button>
    </div>
    <div class="detail-box">
      <div><strong>ã‚¿ã‚¤ãƒˆãƒ«ï¼š</strong>${e.title}</div>
      <div><strong>ãƒ‡ã‚¶ã‚¤ãƒ³ï¼š</strong>${e.type}</div>
      <div><strong>å¯¾è±¡ãŒã‚“ç¨®ï¼š</strong>${e.cancer}</div>
      <div><strong>ç™ºè¡¨å¹´ï¼š</strong>${e.year}å¹´</div>
      <div><strong>ä¸»è¦æ‰€è¦‹ï¼š</strong>${e.outcome}</div>
      <div><strong>ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãƒ¬ãƒ™ãƒ«ï¼š</strong>${e.level}</div>
    </div>
    <p>${e.summary}</p>
    <div class="detail-box"><strong>å‡ºå…¸ï¼š</strong>${e.link}</div>
    <button class="cta" onclick="openFacilityContact('ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ç›¸è«‡')">ã“ã®ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã§ç›¸è«‡ã™ã‚‹</button>
  `;
};

/* ===== ç”Ÿå­˜ç‡ ===== */
function renderSurvivals(list){
  return `<div class="cards-grid">${
    list.map(s=>`
      <div class="x-card" onclick="showSurvivalDetail(${s.id})" role="button" tabindex="0">
        <h3>${s.cancer}ï¼ˆ${s.stage}ï¼‰</h3>
        <div class="x-meta">1å¹´: ${s.one}% ï¼ 3å¹´: ${s.three}% ï¼ 5å¹´: ${s.five}%</div>
        <div><span class="x-tag">çµ±è¨ˆ</span><span class="x-tag">${s.cancer}</span></div>
        <button type="button">è©³ç´°ã‚’è¦‹ã‚‹</button>
      </div>`).join("")
  }</div>`;
}
function showSurvivalList(){
  container.classList.remove("active"); finalView.classList.add("active");
  finalContent.innerHTML = `
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
      <div style="width:18px;height:18px;background-image:var(--logo-small);background-size:cover;border-radius:4px"></div>
      <strong>SATOI ç”Ÿå­˜ç‡</strong>
    </div>
    ${renderSurvivals(survivals)}`;
}
window.showSurvivalDetail = function(id){
  const s=survivals.find(x=>x.id===id); if(!s) return;
  finalContent.innerHTML = `
    <div class="detail-head">
      <h2>ç”Ÿå­˜ç‡è©³ç´°</h2>
      <button class="back-link" onclick="showSurvivalList()">â† ä¸€è¦§ã¸æˆ»ã‚‹</button>
    </div>
    <div class="detail-box">
      <div><strong>ãŒã‚“ç¨®ï¼š</strong>${s.cancer}</div>
      <div><strong>ã‚¹ãƒ†ãƒ¼ã‚¸ï¼š</strong>${s.stage}</div>
      <div><strong>1å¹´ï¼š</strong>${s.one}%ã€€<strong>3å¹´ï¼š</strong>${s.three}%ã€€<strong>5å¹´ï¼š</strong>${s.five}%</div>
      <div><strong>å‡ºå…¸ï¼š</strong>${s.source}</div>
    </div>
    <p>æ•°å€¤ã¯çµ±è¨ˆã®ä¾‹ç¤ºã§ã™ã€‚å…·ä½“çš„ãªæ²»ç™‚é¸æŠã¯ä¸»æ²»åŒ»ã¨ã”ç›¸è«‡ãã ã•ã„ã€‚</p>
    <button class="cta" onclick="openFacilityContact('${s.cancer} ç”Ÿå­˜ç‡ç›¸è«‡')">ã“ã®ãŒã‚“ã®æ²»ç™‚ç›¸è«‡ã‚’ã™ã‚‹</button>
  `;
};

/* ===== åˆæœŸè¡¨ç¤ºï¼š1ç§’å¾Œã«ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ â†’ è³ªå•ã‚«ãƒ¼ãƒ‰é–‹å§‹ ===== */
setTimeout(()=>{
  document.getElementById("view1").classList.add("fade-out");
  setTimeout(()=>{
    document.getElementById("view1").style.display="none";
    document.getElementById("card-container").classList.add("active");
    createCard(currentNode);
  },500);
},1000);

function startTutorial() {
  document.getElementById('tutorial-overlay').style.display = 'none';
  const card = document.querySelector('.card');
  if(card) {
    card.animate([
      { transform: 'translateX(0)' },
      { transform: 'translateX(12px)' },
      { transform: 'translateX(0)' }
    ], { duration: 600, iterations: 2 });
  }
}

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å¾Œã«ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«è¡¨ç¤º
window.addEventListener('load', () => {
  document.getElementById('tutorial-overlay').style.display = 'flex';
});
</script>
</body>
</html>